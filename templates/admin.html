{% extends "base.html" %}

{% block title %}管理画面 - 基本情報技術者試験 学習プラットフォーム{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">🔧 管理画面</h1>
        <p class="text-gray-600">システムの管理と問題の追加を行えます。</p>
    </div>

    <!-- 統計情報 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="text-3xl">📚</div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">総問題数</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ data.question_count }}</p>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="text-3xl">👥</div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">登録ユーザー数</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ data.user_count }}</p>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="text-3xl">🏷️</div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">ジャンル数</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ data.genres|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 問題追加フォーム -->
    <div class="card p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">➕ 新しい問題を追加</h2>
        
        <form id="addQuestionForm" class="space-y-6">
            <!-- 問題文 -->
            <div>
                <label for="questionText" class="block text-sm font-medium text-gray-700 mb-2">
                    問題文 <span class="text-red-500">*</span>
                </label>
                <textarea id="questionText" name="question_text" rows="4" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="問題文を入力してください" required></textarea>
            </div>

            <!-- 選択肢 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    選択肢 <span class="text-red-500">*</span>
                </label>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3">
                        <span class="font-medium text-gray-700 w-6">A.</span>
                        <input type="text" id="choiceA" name="choice_a" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="選択肢A" required>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-medium text-gray-700 w-6">B.</span>
                        <input type="text" id="choiceB" name="choice_b" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="選択肢B" required>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-medium text-gray-700 w-6">C.</span>
                        <input type="text" id="choiceC" name="choice_c" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="選択肢C" required>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-medium text-gray-700 w-6">D.</span>
                        <input type="text" id="choiceD" name="choice_d" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="選択肢D" required>
                    </div>
                </div>
            </div>

            <!-- 正解 -->
            <div>
                <label for="correctAnswer" class="block text-sm font-medium text-gray-700 mb-2">
                    正解 <span class="text-red-500">*</span>
                </label>
                <select id="correctAnswer" name="correct_answer" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    <option value="">正解を選択してください</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>

            <!-- 解説 -->
            <div>
                <label for="explanation" class="block text-sm font-medium text-gray-700 mb-2">解説</label>
                <textarea id="explanation" name="explanation" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="解説を入力してください（任意）"></textarea>
            </div>

            <!-- ジャンル -->
            <div>
                <label for="genre" class="block text-sm font-medium text-gray-700 mb-2">ジャンル</label>
                <input type="text" id="genre" name="genre" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="例: アルゴリズム・データ構造" list="genreList">
                <datalist id="genreList">
                    {% for genre in data.genres %}
                    <option value="{{ genre }}">
                    {% endfor %}
                </datalist>
            </div>

            <!-- 難易度 -->
            <div>
                <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-2">難易度</label>
                <select id="difficulty" name="difficulty" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="基礎">基礎</option>
                    <option value="標準">標準</option>
                    <option value="応用">応用</option>
                </select>
            </div>

            <!-- 送信ボタン -->
            <div class="flex justify-end space-x-4">
                <button type="button" id="resetForm" class="btn-secondary">
                    リセット
                </button>
                <button type="submit" id="submitQuestion" class="btn-primary">
                    問題を追加
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addQuestionForm');
    const submitBtn = document.getElementById('submitQuestion');
    const resetBtn = document.getElementById('resetForm');
    
    // フォーム送信
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const questionData = {
            question_text: formData.get('question_text'),
            choices: [
                formData.get('choice_a'),
                formData.get('choice_b'),
                formData.get('choice_c'),
                formData.get('choice_d')
            ],
            correct_answer: formData.get('correct_answer'),
            explanation: formData.get('explanation'),
            genre: formData.get('genre'),
            difficulty: formData.get('difficulty')
        };
        
        // バリデーション
        if (!questionData.question_text.trim()) {
            alert('問題文を入力してください。');
            return;
        }
        
        if (questionData.choices.some(choice => !choice.trim())) {
            alert('すべての選択肢を入力してください。');
            return;
        }
        
        if (!questionData.correct_answer) {
            alert('正解を選択してください。');
            return;
        }
        
        // ボタンを無効化
        submitBtn.disabled = true;
        submitBtn.textContent = '追加中...';
        
        // 問題を追加
        fetch('/admin/add_question', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(questionData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('問題が正常に追加されました！');
                form.reset();
                // ページをリロードして統計を更新
                window.location.reload();
            } else {
                alert('エラー: ' + (data.error || '問題の追加に失敗しました'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('エラーが発生しました。');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = '問題を追加';
        });
    });
    
    // リセットボタン
    resetBtn.addEventListener('click', function() {
        if (confirm('入力内容をリセットしますか？')) {
            form.reset();
        }
    });
    
    // フォーム要素のアニメーション
    const formElements = form.querySelectorAll('div');
    formElements.forEach((element, index) => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(20px)';
        setTimeout(() => {
            element.style.transition = 'all 0.3s ease';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 50);
    });
});
</script>
{% endblock %}
