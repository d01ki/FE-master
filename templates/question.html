{% extends "base.html" %}

{% block title %}問題 - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- 問題カード -->
    <div class="card mb-8">
        <div class="card-header">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-question-circle mr-2 text-primary"></i>問題
                </h2>
                <div class="flex items-center space-x-2">
                    {% if question.genre %}
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                            {{ question.genre }}
                        </span>
                    {% endif %}
                    <span class="text-sm text-gray-500">ID: {{ question.question_id or question.id }}</span>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- 問題文 -->
            <div class="mb-6">
                <p class="text-lg leading-relaxed text-gray-800">{{ question.question_text }}</p>
            </div>
            
            <!-- 選択肢 -->
            <div class="space-y-3 mb-6">
                {% for choice_key, choice_text in question.choices.items() %}
                    <label class="choice-option flex items-start p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="radio" name="answer" value="{{ choice_key }}" class="mt-1 mr-3 text-primary focus:ring-primary">
                        <div class="flex-1">
                            <span class="font-medium text-gray-700 mr-2">{{ choice_key }}.</span>
                            <span class="text-gray-800">{{ choice_text }}</span>
                        </div>
                    </label>
                {% endfor %}
            </div>
            
            <!-- 解答ボタン -->
            <div class="flex justify-between items-center">
                <a href="{{ url_for('random_question') }}" class="btn btn-secondary">
                    <i class="fas fa-random mr-2"></i>次の問題
                </a>
                <button id="submit-answer" class="btn btn-primary" disabled>
                    <i class="fas fa-check mr-2"></i>解答する
                </button>
            </div>
        </div>
    </div>
    
    <!-- 解答結果エリア（非表示） -->
    <div id="result-area" class="card hidden">
        <div class="card-header">
            <h3 class="text-lg font-semibold" id="result-title">解答結果</h3>
        </div>
        <div class="card-body">
            <div id="result-content"></div>
            
            <!-- 解説エリア -->
            <div id="explanation-area" class="mt-4 hidden">
                <h4 class="font-semibold text-gray-900 mb-2">解説</h4>
                <p id="explanation-text" class="text-gray-700 leading-relaxed"></p>
            </div>
            
            <!-- アクションボタン -->
            <div class="flex justify-between items-center mt-6">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="fas fa-home mr-2"></i>ダッシュボードに戻る
                </a>
                <a href="{{ url_for('random_question') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-right mr-2"></i>次の問題へ
                </a>
            </div>
        </div>
    </div>
    
    <!-- 学習のヒント -->
    <div class="card mt-8">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>学習のヒント
            </h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                <div class="flex items-center">
                    <i class="fas fa-clock mr-2 text-blue-500"></i>
                    <span>落ち着いて問題文を最後まで読みましょう</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-search mr-2 text-green-500"></i>
                    <span>キーワードに注目して選択肢を絞り込みます</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-times mr-2 text-red-500"></i>
                    <span>明らかに間違いの選択肢から除外します</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-check-double mr-2 text-purple-500"></i>
                    <span>解答後は解説を読んで理解を深めましょう</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const answerInputs = document.querySelectorAll('input[name="answer"]');
    const submitButton = document.getElementById('submit-answer');
    const resultArea = document.getElementById('result-area');
    const resultTitle = document.getElementById('result-title');
    const resultContent = document.getElementById('result-content');
    const explanationArea = document.getElementById('explanation-area');
    const explanationText = document.getElementById('explanation-text');
    
    // 選択肢が選ばれたときの処理
    answerInputs.forEach(input => {
        input.addEventListener('change', function() {
            submitButton.disabled = false;
            // 選択された選択肢をハイライト
            document.querySelectorAll('.choice-option').forEach(option => {
                option.classList.remove('ring-2', 'ring-primary', 'bg-blue-50');
            });
            this.closest('.choice-option').classList.add('ring-2', 'ring-primary', 'bg-blue-50');
        });
    });
    
    // 解答ボタンクリック時の処理
    submitButton.addEventListener('click', function() {
        const selectedAnswer = document.querySelector('input[name="answer"]:checked');
        
        if (!selectedAnswer) {
            alert('選択肢を選んでください。');
            return;
        }
        
        // ボタンを無効化してローディング表示
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>採点中...';
        
        // 解答を送信
        fetch(`/questions/{{ question.id }}/answer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                answer: selectedAnswer.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('エラー: ' + data.error);
                return;
            }
            
            showResult(data);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('解答送信中にエラーが発生しました。');
        })
        .finally(() => {
            // ボタンを再有効化
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check mr-2"></i>解答済み';
        });
    });
    
    function showResult(data) {
        // 正解/不正解の表示
        const isCorrect = data.is_correct;
        
        resultTitle.innerHTML = isCorrect 
            ? '<i class="fas fa-check-circle mr-2 text-green-500"></i>正解！'
            : '<i class="fas fa-times-circle mr-2 text-red-500"></i>不正解';
        
        // 結果内容を作成
        let resultHTML = `
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                    <span class="font-medium ${isCorrect ? 'text-green-800' : 'text-red-800'}">
                        あなたの解答: ${data.user_answer}
                    </span>
                    ${isCorrect ? 
                        '<i class="fas fa-check text-green-500"></i>' : 
                        '<i class="fas fa-times text-red-500"></i>'
                    }
                </div>
        `;
        
        if (!isCorrect) {
            resultHTML += `
                <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <span class="font-medium text-blue-800">
                        正解: ${data.correct_answer}
                    </span>
                    <i class="fas fa-lightbulb text-blue-500"></i>
                </div>
            `;
        }
        
        resultHTML += '</div>';
        resultContent.innerHTML = resultHTML;
        
        // 解説がある場合は表示
        if (data.explanation && data.explanation.trim()) {
            explanationText.textContent = data.explanation;
            explanationArea.classList.remove('hidden');
        }
        
        // 選択肢の色分け
        answerInputs.forEach(input => {
            const option = input.closest('.choice-option');
            option.classList.remove('hover:bg-gray-50', 'cursor-pointer');
            input.disabled = true;
            
            if (input.value === data.correct_answer) {
                option.classList.add('bg-green-50', 'border-green-300');
            } else if (input.value === data.user_answer && !isCorrect) {
                option.classList.add('bg-red-50', 'border-red-300');
            }
        });
        
        // 結果エリアを表示
        resultArea.classList.remove('hidden');
        resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // 解答ボタンを無効化
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-check mr-2"></i>解答済み';
    }
    
    // キーボードショートカット
    document.addEventListener('keydown', function(e) {
        // 数字キーで選択肢を選択
        if (e.key >= '1' && e.key <= '4') {
            const choices = ['ア', 'イ', 'ウ', 'エ'];
            const choiceIndex = parseInt(e.key) - 1;
            if (choiceIndex < choices.length) {
                const targetInput = document.querySelector(`input[value="${choices[choiceIndex]}"]`);
                if (targetInput && !targetInput.disabled) {
                    targetInput.checked = true;
                    targetInput.dispatchEvent(new Event('change'));
                }
            }
        }
        
        // Enterキーで解答送信
        if (e.key === 'Enter' && !submitButton.disabled) {
            e.preventDefault();
            submitButton.click();
        }
        
        // Spaceキーで次の問題
        if (e.key === ' ' && submitButton.innerHTML.includes('解答済み')) {
            e.preventDefault();
            window.location.href = "{{ url_for('random_question') }}";
        }
    });
    
    // 選択肢のホバー効果を改善
    document.querySelectorAll('.choice-option').forEach(option => {
        option.addEventListener('mouseenter', function() {
            if (!this.querySelector('input').disabled) {
                this.classList.add('shadow-md');
            }
        });
        
        option.addEventListener('mouseleave', function() {
            this.classList.remove('shadow-md');
        });
    });
});
</script>
{% endblock %}
