{% extends "base.html" %}

{% block title %}問題 - 基本情報技術者試験 学習プラットフォーム{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="card p-8">
        <!-- 問題情報 -->
        <div class="mb-6">
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    {{ question.genre }}
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    {{ question.difficulty }}
                </span>
            </div>
        </div>

        <!-- 問題文 -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">問題</h2>
            <p class="text-gray-800 leading-relaxed">{{ question.question_text }}</p>
        </div>

        <!-- 選択肢 -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">選択肢</h3>
            <div class="space-y-3" id="choices">
                {% for choice in question.choices %}
                <label class="flex items-start p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-200">
                    <input type="radio" name="answer" value="{{ loop.index0|chr(65) }}" class="mt-1 mr-3 text-blue-600">
                    <div>
                        <span class="font-medium text-gray-700">{{ loop.index0|chr(65) }}.</span>
                        <span class="ml-2 text-gray-800">{{ choice }}</span>
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- 解答ボタン -->
        <div class="flex flex-col sm:flex-row gap-4">
            <button id="submitAnswer" class="btn-primary flex-1">
                解答する
            </button>
            <a href="{{ url_for('random') }}" class="btn-secondary flex-1 text-center">
                次の問題
            </a>
        </div>

        <!-- 解答結果 -->
        <div id="result" class="mt-8 hidden">
            <div id="resultContent" class="p-6 rounded-lg">
                <!-- JavaScript で動的に追加 -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submitAnswer');
    const resultDiv = document.getElementById('result');
    const resultContent = document.getElementById('resultContent');
    
    submitBtn.addEventListener('click', function() {
        const selectedAnswer = document.querySelector('input[name="answer"]:checked');
        
        if (!selectedAnswer) {
            alert('選択肢を選んでください。');
            return;
        }
        
        // ボタンを無効化
        submitBtn.disabled = true;
        submitBtn.textContent = '解答中...';
        
        // 解答を送信
        fetch(`/questions/{{ question.id }}/answer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                answer: selectedAnswer.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                submitBtn.disabled = false;
                submitBtn.textContent = '解答する';
                return;
            }
            
            // 結果を表示
            const isCorrect = data.is_correct;
            const correctAnswer = data.correct_answer;
            const explanation = data.explanation;
            
            resultContent.innerHTML = `
                <div class="${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded-lg p-4 mb-4">
                    <h4 class="${isCorrect ? 'text-green-800' : 'text-red-800'} font-bold text-lg mb-2">
                        ${isCorrect ? '✅ 正解！' : '❌ 不正解'}
                    </h4>
                    <p class="${isCorrect ? 'text-green-700' : 'text-red-700'}">
                        正解: ${correctAnswer}
                    </p>
                </div>
                
                ${explanation ? `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="text-blue-800 font-bold mb-2">📝 解説</h4>
                    <p class="text-blue-700">${explanation}</p>
                </div>
                ` : ''}
            `;
            
            resultDiv.classList.remove('hidden');
            
            // 選択肢を無効化
            document.querySelectorAll('input[name="answer"]').forEach(input => {
                input.disabled = true;
            });
            
            // 正解の選択肢をハイライト
            document.querySelectorAll('label').forEach((label, index) => {
                const letter = String.fromCharCode(65 + index);
                if (letter === correctAnswer) {
                    label.classList.add('bg-green-100', 'border-green-300');
                } else if (selectedAnswer.value === letter && !isCorrect) {
                    label.classList.add('bg-red-100', 'border-red-300');
                }
            });
            
            submitBtn.textContent = '解答済み';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('エラーが発生しました。');
            submitBtn.disabled = false;
            submitBtn.textContent = '解答する';
        });
    });
});
</script>
{% endblock %}

{% block scripts %}
<script>
// ページ読み込み時のアニメーション
document.addEventListener('DOMContentLoaded', function() {
    const choices = document.querySelectorAll('#choices label');
    choices.forEach((choice, index) => {
        setTimeout(() => {
            choice.style.opacity = '0';
            choice.style.transform = 'translateY(20px)';
            choice.style.transition = 'all 0.3s ease';
            setTimeout(() => {
                choice.style.opacity = '1';
                choice.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
});
</script>
{% endblock %}
