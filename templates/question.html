{% extends "base.html" %}

{% block title %}ÂïèÈ°å - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- ÂïèÈ°å„Ç´„Éº„Éâ -->
    <div class="card mb-8">
        <div class="card-header">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-question-circle mr-2 text-primary"></i>ÂïèÈ°å
                </h2>
                <div class="flex items-center space-x-2">
                    {% if question.genre %}
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                            {{ question.genre }}
                        </span>
                    {% endif %}
                    <span class="text-sm text-gray-500">ID: {{ question.question_id or question.id }}</span>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- ÂïèÈ°åÊñá -->
            <div class="mb-6">
                <p class="text-lg leading-relaxed text-gray-800">{{ question.question_text }}</p>
            </div>
            
            <!-- ÈÅ∏ÊäûËÇ¢ -->
            <div class="space-y-3 mb-6">
                {% for choice_key, choice_text in question.choices.items() %}
                    <label class="choice-option flex items-start p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all duration-200 hover:shadow-md">
                        <input type="radio" name="answer" value="{{ choice_key }}" class="mt-1 mr-3 text-primary focus:ring-primary">
                        <div class="flex-1">
                            <span class="font-medium text-gray-700 mr-2">{{ choice_key }}.</span>
                            <span class="text-gray-800">{{ choice_text }}</span>
                        </div>
                    </label>
                {% endfor %}
            </div>
            
            <!-- „Çπ„Éû„Éº„Éà„Å™„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
            <div class="flex justify-center">
                <div class="relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl blur opacity-30 group-hover:opacity-70 transition duration-1000 group-hover:duration-200"></div>
                    <a href="{{ url_for('random_question') }}" class="relative flex items-center px-8 py-3 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        <span class="mr-3 text-lg">üéØ</span>
                        <span>Ê¨°„ÅÆÂïèÈ°å</span>
                        <i class="fas fa-arrow-right ml-3 text-primary"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ëß£Á≠îÁµêÊûú„Ç®„É™„Ç¢ÔºàÈùûË°®Á§∫Ôºâ -->
    <div id="result-area" class="card hidden">
        <div class="card-header">
            <h3 class="text-lg font-semibold" id="result-title">Ëß£Á≠îÁµêÊûú</h3>
        </div>
        <div class="card-body">
            <div id="result-content"></div>
        </div>
    </div>
    
    <!-- Ëß£Ë™¨„Ç®„É™„Ç¢ -->
    <div id="explanation-area" class="card mt-6 hidden">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Ëß£Ë™¨
            </h3>
        </div>
        <div class="card-body">
            <p id="explanation-text" class="text-gray-700 leading-relaxed text-base mb-6"></p>
            
            <!-- „Çπ„Éû„Éº„Éà„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
            <div class="flex justify-center">
                <div class="relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-green-500 to-blue-600 rounded-xl blur opacity-30 group-hover:opacity-70 transition duration-1000 group-hover:duration-200"></div>
                    <a href="{{ url_for('random_question') }}" class="relative flex items-center px-8 py-3 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        <span class="mr-3 text-lg">üöÄ</span>
                        <span>Ê¨°„ÅÆÂïèÈ°å„Å∏</span>
                        <i class="fas fa-chevron-right ml-3 text-primary"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const answerInputs = document.querySelectorAll('input[name="answer"]');
    const resultArea = document.getElementById('result-area');
    const resultTitle = document.getElementById('result-title');
    const resultContent = document.getElementById('result-content');
    const explanationArea = document.getElementById('explanation-area');
    const explanationText = document.getElementById('explanation-text');
    
    let answered = false;
    
    // ÈÅ∏ÊäûËÇ¢„ÅåÈÅ∏„Å∞„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜÔºàÂç≥Â∫ß„Å´Ëß£Á≠îÂà§ÂÆöÔºâ
    answerInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (answered) return; // Êó¢„Å´Ëß£Á≠îÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            
            answered = true;
            const selectedAnswer = this.value;
            
            // „Åô„Åπ„Å¶„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÁÑ°ÂäπÂåñ
            answerInputs.forEach(inp => inp.disabled = true);
            
            // Ëß£Á≠î„ÇíÈÄÅ‰ø°
            fetch(`/questions/{{ question.id }}/answer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    answer: selectedAnswer
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('„Ç®„É©„Éº: ' + data.error);
                    return;
                }
                
                showResult(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ëß£Á≠îÈÄÅ‰ø°‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            });
        });
    });
    
    function showResult(data) {
        // Ê≠£Ëß£/‰∏çÊ≠£Ëß£„ÅÆË°®Á§∫
        const isCorrect = data.is_correct;
        
        resultTitle.innerHTML = isCorrect 
            ? '<i class="fas fa-check-circle mr-2 text-green-500"></i>Ê≠£Ëß£ÔºÅ'
            : '<i class="fas fa-times-circle mr-2 text-red-500"></i>‰∏çÊ≠£Ëß£';
        
        // ÁµêÊûúÂÜÖÂÆπ„Çí‰ΩúÊàê
        let resultHTML = `
            <div class="space-y-3">
                <div class="flex items-center justify-between p-4 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                    <span class="font-medium text-lg ${isCorrect ? 'text-green-800' : 'text-red-800'}">
                        „ÅÇ„Å™„Åü„ÅÆËß£Á≠î: ${data.user_answer}
                    </span>
                    ${isCorrect ? 
                        '<i class="fas fa-check text-green-500 text-xl"></i>' : 
                        '<i class="fas fa-times text-red-500 text-xl"></i>'
                    }
                </div>
        `;
        
        if (!isCorrect) {
            resultHTML += `
                <div class="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <span class="font-medium text-lg text-blue-800">
                        Ê≠£Ëß£: ${data.correct_answer}
                    </span>
                    <i class="fas fa-lightbulb text-blue-500 text-xl"></i>
                </div>
            `;
        }
        
        resultHTML += '</div>';
        resultContent.innerHTML = resultHTML;
        
        // ÈÅ∏ÊäûËÇ¢„ÅÆËâ≤ÂàÜ„Åë
        answerInputs.forEach(input => {
            const option = input.closest('.choice-option');
            option.classList.remove('hover:bg-gray-50', 'cursor-pointer', 'hover:shadow-md');
            
            if (input.value === data.correct_answer) {
                option.classList.add('bg-green-50', 'border-green-300', 'border-2');
            } else if (input.value === data.user_answer && !isCorrect) {
                option.classList.add('bg-red-50', 'border-red-300', 'border-2');
            }
        });
        
        // ÁµêÊûú„Ç®„É™„Ç¢„ÇíË°®Á§∫
        resultArea.classList.remove('hidden');
        
        // Ëß£Ë™¨„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
        if (data.explanation && data.explanation.trim()) {
            explanationText.textContent = data.explanation;
            explanationArea.classList.remove('hidden');
        }
        
        // ÁµêÊûú„Ç®„É™„Ç¢„Å´„Çπ„ÇØ„É≠„Éº„É´
        resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    document.addEventListener('keydown', function(e) {
        if (answered) {
            // Ëß£Á≠îÂæå„ÅØSpace„Ç≠„Éº„ÅßÊ¨°„ÅÆÂïèÈ°å
            if (e.key === ' ') {
                e.preventDefault();
                window.location.href = "{{ url_for('random_question') }}";
            }
            return;
        }
        
        // Êï∞Â≠ó„Ç≠„Éº„ÅßÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏Êäû
        if (e.key >= '1' && e.key <= '4') {
            const choices = ['„Ç¢', '„Ç§', '„Ç¶', '„Ç®'];
            const choiceIndex = parseInt(e.key) - 1;
            if (choiceIndex < choices.length) {
                const targetInput = document.querySelector(`input[value="${choices[choiceIndex]}"]`);
                if (targetInput && !targetInput.disabled) {
                    targetInput.checked = true;
                    targetInput.dispatchEvent(new Event('change'));
                }
            }
        }
    });
    
    // ÈÅ∏ÊäûËÇ¢„ÅÆ„Éõ„Éê„ÉºÂäπÊûú
    document.querySelectorAll('.choice-option').forEach(option => {
        option.addEventListener('mouseenter', function() {
            if (!this.querySelector('input').disabled && !answered) {
                this.classList.add('scale-105');
            }
        });
        
        option.addEventListener('mouseleave', function() {
            this.classList.remove('scale-105');
        });
    });
});
</script>
{% endblock %}
