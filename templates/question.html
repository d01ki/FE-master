{% extends "base.html" %}

{% block title %}問題 - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- 問題カード -->
    <div class="card mb-8">
        <div class="card-header">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-question-circle mr-2 text-primary"></i>問題
                </h2>
                <div class="flex items-center space-x-2">
                    {% if question.genre %}
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                            {{ question.genre }}
                        </span>
                    {% endif %}
                    <span class="text-sm text-gray-500">ID: {{ question.question_id or question.id }}</span>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- 問題文 -->
            <div class="mb-6">
                <p class="text-lg leading-relaxed text-gray-800">{{ question.question_text }}</p>
            </div>
            
            <!-- 選択肢 -->
            <div class="space-y-3 mb-6">
                {% for choice_key, choice_text in question.choices.items() %}
                    <label class="choice-option flex items-start p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="radio" name="answer" value="{{ choice_key }}" class="mt-1 mr-3 text-primary focus:ring-primary">
                        <div class="flex-1">
                            <span class="font-medium text-gray-700 mr-2">{{ choice_key }}.</span>
                            <span class="text-gray-800">{{ choice_text }}</span>
                        </div>
                    </label>
                {% endfor %}
            </div>
            
            <!-- ナビゲーションボタン -->
            <div class="flex justify-center">
                <a href="{{ url_for('random_question') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-right mr-2"></i>次の問題
                </a>
            </div>
        </div>
    </div>
    
    <!-- 解答結果エリア（非表示） -->
    <div id="result-area" class="card hidden">
        <div class="card-header">
            <h3 class="text-lg font-semibold" id="result-title">解答結果</h3>
        </div>
        <div class="card-body">
            <div id="result-content"></div>
        </div>
    </div>
    
    <!-- 解説エリア -->
    <div id="explanation-area" class="card mt-6 hidden">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>解説
            </h3>
        </div>
        <div class="card-body">
            <p id="explanation-text" class="text-gray-700 leading-relaxed text-base"></p>
            
            <!-- アクションボタン -->
            <div class="flex justify-center mt-6">
                <a href="{{ url_for('random_question') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-right mr-2"></i>次の問題へ
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const answerInputs = document.querySelectorAll('input[name="answer"]');
    const resultArea = document.getElementById('result-area');
    const resultTitle = document.getElementById('result-title');
    const resultContent = document.getElementById('result-content');
    const explanationArea = document.getElementById('explanation-area');
    const explanationText = document.getElementById('explanation-text');
    
    let answered = false;
    
    // 選択肢が選ばれたときの処理（即座に解答判定）
    answerInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (answered) return; // 既に解答済みの場合は何もしない
            
            answered = true;
            const selectedAnswer = this.value;
            
            // すべての選択肢を無効化
            answerInputs.forEach(inp => inp.disabled = true);
            
            // 解答を送信
            fetch(`/questions/{{ question.id }}/answer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    answer: selectedAnswer
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                    return;
                }
                
                showResult(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('解答送信中にエラーが発生しました。');
            });
        });
    });
    
    function showResult(data) {
        // 正解/不正解の表示
        const isCorrect = data.is_correct;
        
        resultTitle.innerHTML = isCorrect 
            ? '<i class="fas fa-check-circle mr-2 text-green-500"></i>正解！'
            : '<i class="fas fa-times-circle mr-2 text-red-500"></i>不正解';
        
        // 結果内容を作成
        let resultHTML = `
            <div class="space-y-3">
                <div class="flex items-center justify-between p-4 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                    <span class="font-medium text-lg ${isCorrect ? 'text-green-800' : 'text-red-800'}">
                        あなたの解答: ${data.user_answer}
                    </span>
                    ${isCorrect ? 
                        '<i class="fas fa-check text-green-500 text-xl"></i>' : 
                        '<i class="fas fa-times text-red-500 text-xl"></i>'
                    }
                </div>
        `;
        
        if (!isCorrect) {
            resultHTML += `
                <div class="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <span class="font-medium text-lg text-blue-800">
                        正解: ${data.correct_answer}
                    </span>
                    <i class="fas fa-lightbulb text-blue-500 text-xl"></i>
                </div>
            `;
        }
        
        resultHTML += '</div>';
        resultContent.innerHTML = resultHTML;
        
        // 選択肢の色分け
        answerInputs.forEach(input => {
            const option = input.closest('.choice-option');
            option.classList.remove('hover:bg-gray-50', 'cursor-pointer');
            
            if (input.value === data.correct_answer) {
                option.classList.add('bg-green-50', 'border-green-300', 'border-2');
            } else if (input.value === data.user_answer && !isCorrect) {
                option.classList.add('bg-red-50', 'border-red-300', 'border-2');
            }
        });
        
        // 結果エリアを表示
        resultArea.classList.remove('hidden');
        
        // 解説がある場合は表示
        if (data.explanation && data.explanation.trim()) {
            explanationText.textContent = data.explanation;
            explanationArea.classList.remove('hidden');
        }
        
        // 結果エリアにスクロール
        resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // キーボードショートカット
    document.addEventListener('keydown', function(e) {
        if (answered) {
            // 解答後はSpaceキーで次の問題
            if (e.key === ' ') {
                e.preventDefault();
                window.location.href = "{{ url_for('random_question') }}";
            }
            return;
        }
        
        // 数字キーで選択肢を選択
        if (e.key >= '1' && e.key <= '4') {
            const choices = ['ア', 'イ', 'ウ', 'エ'];
            const choiceIndex = parseInt(e.key) - 1;
            if (choiceIndex < choices.length) {
                const targetInput = document.querySelector(`input[value="${choices[choiceIndex]}"]`);
                if (targetInput && !targetInput.disabled) {
                    targetInput.checked = true;
                    targetInput.dispatchEvent(new Event('change'));
                }
            }
        }
    });
    
    // 選択肢のホバー効果
    document.querySelectorAll('.choice-option').forEach(option => {
        option.addEventListener('mouseenter', function() {
            if (!this.querySelector('input').disabled && !answered) {
                this.classList.add('shadow-md', 'scale-105');
            }
        });
        
        option.addEventListener('mouseleave', function() {
            this.classList.remove('shadow-md', 'scale-105');
        });
    });
});
</script>
{% endblock %}
