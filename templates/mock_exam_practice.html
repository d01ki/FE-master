{% extends "base.html" %}

{% block title %}æ¨¡æ“¬è©¦é¨“ - åŸºæœ¬æƒ…å ±æŠ€è¡“è€…è©¦é¨“ å­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ {% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">ğŸ“ æ¨¡æ“¬è©¦é¨“</h1>
        <p class="text-gray-600">{{ exam_info.display_name }}ã®æ¨¡æ“¬è©¦é¨“ã§ã™ã€‚æ™‚é–“ã‚’æ¸¬ã£ã¦æœ¬ç•ªã•ãªãŒã‚‰ã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ã€‚</p>
    </div>

    <!-- è©¦é¨“æƒ…å ± -->
    <div class="card p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-900">{{ exam_info.display_name }}</h2>
            <div id="timer" class="text-lg font-mono font-semibold text-blue-600">
                00:00:00
            </div>
        </div>
        <div class="flex items-center space-x-6 text-sm text-gray-600">
            <span>ğŸ“š å•é¡Œæ•°: {{ questions|length }}å•</span>
            <span>â±ï¸ åˆ¶é™æ™‚é–“: ãªã—</span>
            <span>ğŸ“Š åˆæ ¼ãƒ©ã‚¤ãƒ³: 60%ä»¥ä¸Š</span>
        </div>
    </div>

    <!-- å•é¡Œä¸€è¦§ -->
    <div class="space-y-8">
        {% for question in questions %}
        <div class="card p-6" id="question-{{ loop.index }}">
            <!-- å•é¡Œãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">å•é¡Œ{{ loop.index }}</h3>
                <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {{ question.genre }}
                    </span>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        {{ question.difficulty }}
                    </span>
                </div>
            </div>

            <!-- å•é¡Œæ–‡ -->
            <div class="mb-6">
                <p class="text-gray-800 leading-relaxed">{{ question.question_text }}</p>
            </div>

            <!-- é¸æŠè‚¢ -->
            <div class="space-y-3 mb-6">
                {% for choice in question.choices %}
                <label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-200">
                    <input type="radio" name="question-{{ question.id }}" value="{{ loop.index0|chr(65) }}" 
                           class="mt-1 mr-3 text-blue-600">
                    <div>
                        <span class="font-medium text-gray-700">{{ loop.index0|chr(65) }}.</span>
                        <span class="ml-2 text-gray-800">{{ choice }}</span>
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- æå‡ºãƒœã‚¿ãƒ³ -->
    <div class="mt-8 text-center">
        <button id="submitExam" class="btn-primary text-lg px-8 py-4">
            è©¦é¨“ã‚’æå‡ºã™ã‚‹
        </button>
    </div>

    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="examResult" class="mt-8 hidden">
        <div class="card p-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">è©¦é¨“çµæœ</h2>
                <div id="resultScore" class="text-4xl font-bold mb-4"></div>
                <div id="resultStatus" class="text-lg font-semibold mb-4"></div>
                <div class="text-sm text-gray-600">
                    è©¦é¨“æ™‚é–“: <span id="finalTime"></span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalQuestions">{{ questions|length }}</div>
                    <div class="text-sm text-gray-600">ç·å•é¡Œæ•°</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="correctAnswers">0</div>
                    <div class="text-sm text-gray-600">æ­£è§£æ•°</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="incorrectAnswers">0</div>
                    <div class="text-sm text-gray-600">ä¸æ­£è§£æ•°</div>
                </div>
            </div>

            <!-- è©³ç´°çµæœ -->
            <div id="detailedResults" class="space-y-4">
                <!-- JavaScript ã§å‹•çš„ã«è¿½åŠ  -->
            </div>

            <div class="text-center mt-8">
                <a href="{{ url_for('index') }}" class="btn-primary mr-4">
                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                </a>
                <a href="{{ url_for('mock_exam') }}" class="btn-secondary">
                    å†æŒ‘æˆ¦
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let startTime = new Date();
    let timerInterval;
    
    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    function startTimer() {
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    function updateTimer() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${hours}:${minutes}:${seconds}`;
    }
    
    function stopTimer() {
        clearInterval(timerInterval);
        const elapsed = Math.floor((new Date() - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        return `${hours}æ™‚é–“${minutes}åˆ†${seconds}ç§’`;
    }
    
    startTimer();
    
    // è©¦é¨“æå‡º
    document.getElementById('submitExam').addEventListener('click', function() {
        const questions = {{ questions|tojson }};
        const answers = {};
        let answeredCount = 0;
        
        // è§£ç­”ã‚’åé›†
        questions.forEach(question => {
            const selectedAnswer = document.querySelector(`input[name="question-${question.id}"]:checked`);
            if (selectedAnswer) {
                answers[question.id] = selectedAnswer.value;
                answeredCount++;
            }
        });
        
        // æœªè§£ç­”ãƒã‚§ãƒƒã‚¯
        if (answeredCount < questions.length) {
            const unanswered = questions.length - answeredCount;
            if (!confirm(`${unanswered}å•ãŒæœªè§£ç­”ã§ã™ã€‚ã“ã®ã¾ã¾æå‡ºã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
        }
        
        // æå‡ºç¢ºèª
        if (!confirm('è©¦é¨“ã‚’æå‡ºã—ã¾ã™ã‹ï¼Ÿæå‡ºå¾Œã¯è§£ç­”ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚')) {
            return;
        }
        
        const finalTime = stopTimer();
        
        // æ¡ç‚¹å‡¦ç†
        let correctCount = 0;
        const results = [];
        
        questions.forEach((question, index) => {
            const userAnswer = answers[question.id] || '';
            const isCorrect = userAnswer === question.correct_answer;
            if (isCorrect) correctCount++;
            
            results.push({
                questionNumber: index + 1,
                question: question.question_text,
                userAnswer: userAnswer,
                correctAnswer: question.correct_answer,
                isCorrect: isCorrect,
                explanation: question.explanation || ''
            });
        });
        
        const score = Math.round((correctCount / questions.length) * 100);
        const passed = score >= 60;
        
        // çµæœè¡¨ç¤º
        showResults(score, correctCount, questions.length - correctCount, finalTime, passed, results);
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        document.getElementById('examResult').scrollIntoView({ behavior: 'smooth' });
    });
    
    function showResults(score, correct, incorrect, time, passed, results) {
        document.getElementById('resultScore').textContent = `${score}ç‚¹`;
        document.getElementById('resultScore').className = `text-4xl font-bold mb-4 ${passed ? 'text-green-600' : 'text-red-600'}`;
        document.getElementById('resultStatus').textContent = passed ? 'ğŸ‰ åˆæ ¼ï¼' : 'ğŸ˜” ä¸åˆæ ¼';
        document.getElementById('resultStatus').className = `text-lg font-semibold mb-4 ${passed ? 'text-green-600' : 'text-red-600'}`;
        document.getElementById('finalTime').textContent = time;
        document.getElementById('correctAnswers').textContent = correct;
        document.getElementById('incorrectAnswers').textContent = incorrect;
        
        // è©³ç´°çµæœ
        const detailedResults = document.getElementById('detailedResults');
        detailedResults.innerHTML = results.map(result => `
            <div class="border rounded-lg p-4 ${result.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold">å•é¡Œ${result.questionNumber}</span>
                    <span class="text-lg">${result.isCorrect ? 'âœ…' : 'âŒ'}</span>
                </div>
                <p class="text-sm text-gray-700 mb-2">${result.question.substring(0, 100)}...</p>
                <div class="text-sm">
                    <div>ã‚ãªãŸã®è§£ç­”: <span class="${result.isCorrect ? 'text-green-600' : 'text-red-600'} font-semibold">${result.userAnswer || 'æœªè§£ç­”'}</span></div>
                    ${!result.isCorrect ? `<div>æ­£è§£: <span class="text-green-600 font-semibold">${result.correctAnswer}</span></div>` : ''}
                    ${result.explanation ? `<div class="mt-2 p-2 bg-blue-50 rounded text-blue-700"><strong>è§£èª¬:</strong> ${result.explanation}</div>` : ''}
                </div>
            </div>
        `).join('');
        
        document.getElementById('examResult').classList.remove('hidden');
        document.getElementById('submitExam').style.display = 'none';
        
        // å•é¡Œã‚’ç„¡åŠ¹åŒ–
        document.querySelectorAll('input[type="radio"]').forEach(input => {
            input.disabled = true;
        });
    }
    
    // ãƒšãƒ¼ã‚¸é›¢è„±è­¦å‘Š
    window.addEventListener('beforeunload', function(e) {
        if (!document.getElementById('examResult').classList.contains('hidden')) {
            return; // çµæœè¡¨ç¤ºæ¸ˆã¿ãªã‚‰è­¦å‘Šã—ãªã„
        }
        e.preventDefault();
        e.returnValue = '';
    });
});
</script>
{% endblock %}
