{% extends "base.html" %}

{% block title %}模擬試験 - 基本情報技術者試験 学習プラットフォーム{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">📝 模擬試験</h1>
        <p class="text-gray-600">{{ exam_info.display_name }}の模擬試験です。時間を測って本番さながらに挑戦しましょう。</p>
    </div>

    <!-- 試験情報 -->
    <div class="card p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-900">{{ exam_info.display_name }}</h2>
            <div id="timer" class="text-lg font-mono font-semibold text-blue-600">
                00:00:00
            </div>
        </div>
        <div class="flex items-center space-x-6 text-sm text-gray-600">
            <span>📚 問題数: {{ questions|length }}問</span>
            <span>⏱️ 制限時間: なし</span>
            <span>📊 合格ライン: 60%以上</span>
        </div>
    </div>

    <!-- 問題一覧 -->
    <div class="space-y-8">
        {% for question in questions %}
        <div class="card p-6" id="question-{{ loop.index }}">
            <!-- 問題ヘッダー -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">問題{{ loop.index }}</h3>
                <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {{ question.genre }}
                    </span>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        {{ question.difficulty }}
                    </span>
                </div>
            </div>

            <!-- 問題文 -->
            <div class="mb-6">
                <p class="text-gray-800 leading-relaxed">{{ question.question_text }}</p>
            </div>

            <!-- 選択肢 -->
            <div class="space-y-3 mb-6">
                {% for choice in question.choices %}
                <label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-200">
                    <input type="radio" name="question-{{ question.id }}" value="{{ loop.index0|chr(65) }}" 
                           class="mt-1 mr-3 text-blue-600">
                    <div>
                        <span class="font-medium text-gray-700">{{ loop.index0|chr(65) }}.</span>
                        <span class="ml-2 text-gray-800">{{ choice }}</span>
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 提出ボタン -->
    <div class="mt-8 text-center">
        <button id="submitExam" class="btn-primary text-lg px-8 py-4">
            試験を提出する
        </button>
    </div>

    <!-- 結果表示エリア -->
    <div id="examResult" class="mt-8 hidden">
        <div class="card p-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">試験結果</h2>
                <div id="resultScore" class="text-4xl font-bold mb-4"></div>
                <div id="resultStatus" class="text-lg font-semibold mb-4"></div>
                <div class="text-sm text-gray-600">
                    試験時間: <span id="finalTime"></span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalQuestions">{{ questions|length }}</div>
                    <div class="text-sm text-gray-600">総問題数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="correctAnswers">0</div>
                    <div class="text-sm text-gray-600">正解数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="incorrectAnswers">0</div>
                    <div class="text-sm text-gray-600">不正解数</div>
                </div>
            </div>

            <!-- 詳細結果 -->
            <div id="detailedResults" class="space-y-4">
                <!-- JavaScript で動的に追加 -->
            </div>

            <div class="text-center mt-8">
                <a href="{{ url_for('index') }}" class="btn-primary mr-4">
                    ダッシュボードに戻る
                </a>
                <a href="{{ url_for('mock_exam') }}" class="btn-secondary">
                    再挑戦
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let startTime = new Date();
    let timerInterval;
    
    // タイマー開始
    function startTimer() {
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    function updateTimer() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${hours}:${minutes}:${seconds}`;
    }
    
    function stopTimer() {
        clearInterval(timerInterval);
        const elapsed = Math.floor((new Date() - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        return `${hours}時間${minutes}分${seconds}秒`;
    }
    
    startTimer();
    
    // 試験提出
    document.getElementById('submitExam').addEventListener('click', function() {
        const questions = {{ questions|tojson }};
        const answers = {};
        let answeredCount = 0;
        
        // 解答を収集
        questions.forEach(question => {
            const selectedAnswer = document.querySelector(`input[name="question-${question.id}"]:checked`);
            if (selectedAnswer) {
                answers[question.id] = selectedAnswer.value;
                answeredCount++;
            }
        });
        
        // 未解答チェック
        if (answeredCount < questions.length) {
            const unanswered = questions.length - answeredCount;
            if (!confirm(`${unanswered}問が未解答です。このまま提出しますか？`)) {
                return;
            }
        }
        
        // 提出確認
        if (!confirm('試験を提出しますか？提出後は解答を変更できません。')) {
            return;
        }
        
        const finalTime = stopTimer();
        
        // 採点処理
        let correctCount = 0;
        const results = [];
        
        questions.forEach((question, index) => {
            const userAnswer = answers[question.id] || '';
            const isCorrect = userAnswer === question.correct_answer;
            if (isCorrect) correctCount++;
            
            results.push({
                questionNumber: index + 1,
                question: question.question_text,
                userAnswer: userAnswer,
                correctAnswer: question.correct_answer,
                isCorrect: isCorrect,
                explanation: question.explanation || ''
            });
        });
        
        const score = Math.round((correctCount / questions.length) * 100);
        const passed = score >= 60;
        
        // 結果表示
        showResults(score, correctCount, questions.length - correctCount, finalTime, passed, results);
        
        // スクロール
        document.getElementById('examResult').scrollIntoView({ behavior: 'smooth' });
    });
    
    function showResults(score, correct, incorrect, time, passed, results) {
        document.getElementById('resultScore').textContent = `${score}点`;
        document.getElementById('resultScore').className = `text-4xl font-bold mb-4 ${passed ? 'text-green-600' : 'text-red-600'}`;
        document.getElementById('resultStatus').textContent = passed ? '🎉 合格！' : '😔 不合格';
        document.getElementById('resultStatus').className = `text-lg font-semibold mb-4 ${passed ? 'text-green-600' : 'text-red-600'}`;
        document.getElementById('finalTime').textContent = time;
        document.getElementById('correctAnswers').textContent = correct;
        document.getElementById('incorrectAnswers').textContent = incorrect;
        
        // 詳細結果
        const detailedResults = document.getElementById('detailedResults');
        detailedResults.innerHTML = results.map(result => `
            <div class="border rounded-lg p-4 ${result.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold">問題${result.questionNumber}</span>
                    <span class="text-lg">${result.isCorrect ? '✅' : '❌'}</span>
                </div>
                <p class="text-sm text-gray-700 mb-2">${result.question.substring(0, 100)}...</p>
                <div class="text-sm">
                    <div>あなたの解答: <span class="${result.isCorrect ? 'text-green-600' : 'text-red-600'} font-semibold">${result.userAnswer || '未解答'}</span></div>
                    ${!result.isCorrect ? `<div>正解: <span class="text-green-600 font-semibold">${result.correctAnswer}</span></div>` : ''}
                    ${result.explanation ? `<div class="mt-2 p-2 bg-blue-50 rounded text-blue-700"><strong>解説:</strong> ${result.explanation}</div>` : ''}
                </div>
            </div>
        `).join('');
        
        document.getElementById('examResult').classList.remove('hidden');
        document.getElementById('submitExam').style.display = 'none';
        
        // 問題を無効化
        document.querySelectorAll('input[type="radio"]').forEach(input => {
            input.disabled = true;
        });
    }
    
    // ページ離脱警告
    window.addEventListener('beforeunload', function(e) {
        if (!document.getElementById('examResult').classList.contains('hidden')) {
            return; // 結果表示済みなら警告しない
        }
        e.preventDefault();
        e.returnValue = '';
    });
});
</script>
{% endblock %}
