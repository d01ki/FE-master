# 📸 選択肢画像表示機能 - 最終実装ガイド

## 🎯 シンプルなデータ構造に変更！

### **新しいアプローチ**
`choices`フィールドに直接画像URLを格納するシンプルな設計に変更しました。

---

## 📋 JSONデータ形式

### **画像選択肢の場合**

```json
{
  "question_id": "2024_s_q1",
  "question_text": "X及びYはそれぞれ0又は1の値をとる変数である。X□YをXとYの論理演算としたとき、次の真理値表が得られた。X □Y の真理値表はどれか。",
  "choices": {
    "ア": "/static/images/answers/2024_s_a1_1.png",
    "イ": "/static/images/answers/2024_s_a1_2.png",
    "ウ": "/static/images/answers/2024_s_a1_3.png",
    "エ": "/static/images/answers/2024_s_a1_4.png"
  },
  "correct_answer": "ウ",
  "explanation": "まずⅠですが、XOR (XY)の演算結果が1になっています...",
  "genre": "基礎論理",
  "image_url": "/static/images/questions/2024_s_q1.png"
}
```

### **テキスト選択肢の場合**

```json
{
  "question_id": "2024_s_q2",
  "question_text": "キーが小文字のアルファベット1文字（a，b，…，z のいずれか）であるデータを...",
  "choices": {
    "ア": "aとi",
    "イ": "bとr",
    "ウ": "cとl",
    "エ": "dとx"
  },
  "correct_answer": "エ",
  "explanation": "dとxの距離は20であり、10の倍数なので衝突が発生します。",
  "genre": "アルゴリズムとプログラミング",
  "image_url": "null"
}
```

---

## 🔍 自動判定の仕組み

### **画像URLの検出**
システムが自動的に選択肢の値を判定します:

```python
def is_image_url(text):
    """テキストが画像URLかどうかを判定"""
    image_patterns = [
        r'/static/images/',
        r'\.png$',
        r'\.jpg$',
        r'\.jpeg$',
        r'\.gif$',
        r'\.svg$',
        r'\.webp$'
    ]
    return any(re.search(pattern, text.lower()) for pattern in image_patterns)
```

### **UIの自動切り替え**
- **画像URL検出時**: 2×2グリッドレイアウト
- **テキスト検出時**: 縦並びリスト表示

---

## 🗂️ 画像ファイルの配置

### **ディレクトリ構造**

```
static/
└── images/
    ├── questions/           # 問題画像
    │   ├── 2024_s_q1.png
    │   ├── 2024_s_q2.png
    │   └── ...
    └── answers/             # 選択肢画像
        ├── 2024_s_a1_1.png  # 問1 - ア
        ├── 2024_s_a1_2.png  # 問1 - イ
        ├── 2024_s_a1_3.png  # 問1 - ウ
        ├── 2024_s_a1_4.png  # 問1 - エ
        └── ...
```

### **命名規則**

#### **問題画像**
```
{year}_{season}_q{number}.png

例:
- 2024_s_q1.png  (2024年春期 問1)
- 2024_a_q15.png (2024年秋期 問15)
```

#### **選択肢画像**
```
{year}_{season}_a{number}_{choice}.png

choice番号:
1 = ア
2 = イ  
3 = ウ
4 = エ

例:
- 2024_s_a1_1.png (2024年春期 問1 選択肢ア)
- 2024_s_a1_2.png (2024年春期 問1 選択肢イ)
```

---

## 🎨 UIの動作

### **画像選択肢の表示（2×2グリッド）**

```
┌──────────────────┬──────────────────┐
│  ア              │  イ              │
│  [画像]          │  [画像]          │
│                  │                  │
└──────────────────┴──────────────────┘
┌──────────────────┬──────────────────┐
│  ウ              │  エ              │
│  [画像]          │  [画像]          │
│                  │                  │
└──────────────────┴──────────────────┘
```

### **テキスト選択肢の表示（リスト）**

```
┌────────────────────────────────┐
│ ア. 選択肢テキスト1              │
└────────────────────────────────┘
┌────────────────────────────────┐
│ イ. 選択肢テキスト2              │
└────────────────────────────────┘
```

---

## ✅ 実装済みの機能

### **1. 自動判定システム**
- ✅ 画像URLの自動検出
- ✅ `has_image_choices`フラグの自動設定
- ✅ UI表示の自動切り替え

### **2. シンプルなデータ構造**
- ✅ `choices`フィールドに直接URL格納
- ✅ 余分なフィールド不要
- ✅ 直感的で管理しやすい

### **3. 後方互換性**
- ✅ 既存のテキスト選択肢も動作
- ✅ `choice_images`フィールドも対応（廃止予定）

---

## 📦 使用例

### **完全なJSONサンプル**

```json
[
  {
    "question_id": "2024_s_q1",
    "question_text": "X及びYはそれぞれ0又は1の値をとる変数である。X□YをXとYの論理演算としたとき、次の真理値表が得られた。X □Y の真理値表はどれか。",
    "choices": {
      "ア": "/static/images/answers/2024_s_a1_1.png",
      "イ": "/static/images/answers/2024_s_a1_2.png",
      "ウ": "/static/images/answers/2024_s_a1_3.png",
      "エ": "/static/images/answers/2024_s_a1_4.png"
    },
    "correct_answer": "ウ",
    "explanation": "まずⅠですが、XOR (XY)の演算結果が1になっています。このときXの値は0なので、 結果が1になるためにはXYは1である必要があります。選択肢のうち00が1であるのは「ウ」と「工」です。続いてⅡですが、XAND (XY) の演算結果が1になっています。このときXの値は1なので、結果が1になるためには (XY) は1である必要があります。選択肢のうち101が1であるのは「ア」「イ」「ウ」です。 したがって両方の条件を満たす「ウ」の真理値表が正解となります。",
    "genre": "基礎論理",
    "image_url": "/static/images/questions/2024_s_q1.png"
  },
  {
    "question_id": "2024_s_q2",
    "question_text": "キーが小文字のアルファベット1文字（a，b，…，z のいずれか）であるデータを、大きさが10のハッシュ表に格納する。ハッシュ関数として、アルファベットのASCIIコードを10進表記法で表したときの1の位の数を用いることにする。衝突が起こるキーの組合せはどれか。ASCIIコードでは昇順に連続した2進数が、アルファベット順にコードとして割り当てられている。",
    "choices": {
      "ア": "aとi",
      "イ": "bとr",
      "ウ": "cとl",
      "エ": "dとx"
    },
    "correct_answer": "エ",
    "explanation": "dとxの距離は20であり、10の倍数なので衝突が発生します。",
    "genre": "アルゴリズムとプログラミング",
    "image_url": "null"
  }
]
```

---

## 🚀 導入手順

### **Step 1: 画像ファイルの配置**

```bash
# ディレクトリ作成
mkdir -p static/images/questions
mkdir -p static/images/answers

# 画像ファイルをコピー
cp 問題画像/* static/images/questions/
cp 選択肢画像/* static/images/answers/
```

### **Step 2: JSONデータの作成**

画像選択肢の場合、`choices`に直接画像URLを記述:

```json
"choices": {
  "ア": "/static/images/answers/2024_s_a1_1.png",
  "イ": "/static/images/answers/2024_s_a1_2.png",
  "ウ": "/static/images/answers/2024_s_a1_3.png",
  "エ": "/static/images/answers/2024_s_a1_4.png"
}
```

### **Step 3: テスト**

1. アプリを起動
   ```bash
   python app.py
   ```

2. 動作確認
   - [ ] 画像選択肢が2×2グリッドで表示
   - [ ] テキスト選択肢がリストで表示
   - [ ] 自動判定が正常に動作

---

## 🔄 既存データとの互換性

### **両方の形式をサポート**

#### **新形式（推奨）**
```json
"choices": {
  "ア": "/static/images/answers/2024_s_a1_1.png"
}
```

#### **旧形式（後方互換性）**
```json
"choices": {
  "ア": "選択肢テキスト"
},
"choice_images": {
  "ア": "/static/images/answers/2024_s_a1_1.png"
}
```

---

## 💡 メリット

### **新しい設計の利点**

1. **シンプル**: 余分なフィールド不要
2. **直感的**: choicesに画像URLを直接記述
3. **柔軟**: テキストと画像を混在可能
4. **自動**: UIが自動で切り替わる
5. **保守性**: データ管理が簡単

---

## 📊 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `question_manager.py` | is_image_url()追加、自動判定機能 |
| `templates/question.html` | has_image_choicesで表示切替 |
| `CHOICE_IMAGE_IMPLEMENTATION_GUIDE.md` | 実装ガイド更新 |

---

## ✅ チェックリスト

### **準備**
- [ ] `static/images/questions/` ディレクトリ作成
- [ ] `static/images/answers/` ディレクトリ作成
- [ ] 画像ファイルを配置
- [ ] JSONデータを新形式で作成

### **動作確認**
- [ ] 画像選択肢が2×2グリッド表示
- [ ] テキスト選択肢がリスト表示
- [ ] 自動判定が正常動作
- [ ] レスポンシブ対応

---

## 🎉 完成！

これで選択肢画像表示機能が完成しました。

### **実装された機能**
✅ `choices`フィールドに直接画像URL格納
✅ 画像URLの自動判定
✅ UIの自動切り替え
✅ 2×2グリッドレイアウト
✅ 後方互換性維持

### **データ構造がシンプルに！**
- 余分なフィールド不要
- 直感的で管理しやすい
- JSONが読みやすい

---

質問や不明点があれば、お気軽にお知らせください！
