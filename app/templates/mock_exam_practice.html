{% extends "base.html" %}

{% block title %}模擬試験 - {{ exam_info.display_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- Header -->
        <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-5 sm:p-6 border border-white/10 mb-6">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white shadow-lg shadow-orange-600/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-wide text-gray-400 font-medium">模擬試験</p>
                        <h1 class="text-xl sm:text-2xl font-bold text-white">{{ exam_info.display_name }}</h1>
                    </div>
                </div>
                <div class="flex items-center gap-3 text-sm text-gray-300">
                    <span
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
                        <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <span class="font-medium"><span id="current-number">1</span> / {{ questions|length }} 問</span>
                    </span>
                    <span
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
                        <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-medium">制限なし</span>
                    </span>
                </div>
            </div>

            <!-- Progress -->
            <div class="mt-4">
                <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                    <div id="progress-bar"
                        class="h-full bg-gradient-to-r from-orange-400 via-amber-300 to-yellow-300 transition-all duration-200"
                        style="width: 5%"></div>
                </div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="glass-card rounded-2xl shadow-2xl border border-white/10 overflow-hidden">
            <div class="p-5 sm:p-6 space-y-4" id="question-container">
                <div class="flex items-center justify-between text-sm text-gray-300">
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1 rounded-full bg-white/10 border border-white/10"
                            id="question-genre">—</span>
                        <span class="px-3 py-1 rounded-full bg-white/10 border border-white/10"
                            id="question-id">—</span>
                    </div>
                    <span class="text-orange-300" id="question-label">設問 1</span>
                </div>
                <p class="text-gray-100 text-base leading-relaxed whitespace-pre-line" id="question-text">読み込み中...</p>
                <div id="question-image" class="hidden"></div>
                <div id="choices-container" class="space-y-2"></div>
            </div>

            <div
                class="px-5 sm:px-6 py-4 bg-white/5 border-t border-white/10 flex items-center justify-between gap-3 flex-wrap">
                <button id="prev-btn"
                    class="px-4 py-2 rounded-xl bg-white/5 text-gray-200 border border-white/10 hover:bg-white/10 transition disabled:opacity-40 disabled:cursor-not-allowed touch-target flex items-center group">
                    <svg class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                    前へ
                </button>
                <div class="flex-1"></div>
                <button id="next-btn"
                    class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 text-white font-bold shadow-lg shadow-orange-500/20 hover:brightness-105 transition-all touch-target flex items-center group">
                    <span id="next-btn-text">次へ</span>
                    <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Result Card (hidden) -->
        <div id="result-card" class="hidden mt-6 bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <div>
                    <p class="text-sm text-gray-400">スコア</p>
                    <h2 class="text-3xl font-bold text-white" id="result-score">0%</h2>
                </div>
                <div class="flex items-center gap-2 text-gray-200">
                    <span id="result-correct"
                        class="px-3 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/40 text-emerald-200 text-sm">正解
                        0 問</span>
                    <span id="result-total" class="px-3 py-1 rounded-full bg-white/10 border border-white/10 text-sm">合計
                        0 問</span>
                </div>
            </div>
            <div class="flex flex-wrap gap-3 mb-4">
                <a href="{{ url_for('exam.mock_exam') }}"
                    class="px-4 py-2 rounded-lg bg-white/10 text-white border border-white/10 hover:bg-white/20 transition touch-target">
                    一覧に戻る
                </a>
                <button onclick="location.reload()"
                    class="px-4 py-2 rounded-lg bg-gradient-to-r from-orange-500 to-amber-400 text-white font-semibold shadow-md hover:brightness-105 transition touch-target">
                    もう一度解く
                </button>
            </div>

            <!-- 詳細結果 -->
            <div id="result-details" class="space-y-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const questions = {{ questions | tojson }};
    const examSessionId = "{{ exam_session_id }}";
    const serveBase = "{{ url_for('images.serve_question_image', filename='__FILENAME__') }}";
    let currentIndex = 0;
    const answers = {};

    function getImageCandidates(val) {
        if (!val) return [];
        const v = String(val).trim();
        if (!v) return [];

        const uniq = new Set();
        const add = (url) => { if (url) uniq.add(url); };
        const fname = v.split(/[\\/]/).pop();

        // Absolute URLs
        if (v.startsWith('http://') || v.startsWith('https://')) add(v);

        // Protected images routes / repo paths
        if (v.startsWith('/images/questions/')) add(v);
        if (v.startsWith('images/questions/')) add('/' + v);
        if (v.includes('protected_images/questions/')) add(serveBase.replace('__FILENAME__', fname));

        // Static fallback
        if (v.startsWith('/static/')) add(v);
        if (v.startsWith('static/')) add('/' + v);

        // Basename fallback to protected route and static
        add(serveBase.replace('__FILENAME__', fname));
        add('/static/images/questions/' + fname);

        return Array.from(uniq);
    }

    function setImageWithFallback(imgEl, candidates, onFail) {
        const list = [...candidates];
        if (list.length === 0) {
            onFail?.();
            return;
        }
        const tryNext = () => {
            if (!list.length) {
                onFail?.();
                return;
            }
            const url = list.shift();
            imgEl.src = url;
            imgEl.onerror = tryNext;
        };
        tryNext();
    }

    function renderChoices(question) {
        const container = document.getElementById('choices-container');
        container.innerHTML = '';
        const hasImage = !!question.has_image_choices;

        Object.entries(question.choices || {}).forEach(([key, value]) => {
            const wrapper = document.createElement('button');
            wrapper.type = 'button';
            wrapper.dataset.choice = key;
            wrapper.className = hasImage
                ? 'relative w-full p-2 bg-white/5 rounded-lg border-2 border-white/10 hover:border-orange-400/70 hover:bg-orange-400/10 transition touch-target'
                : 'w-full text-left p-3 sm:p-4 bg-white/5 rounded-xl border-2 border-white/10 hover:border-orange-400/70 hover:bg-orange-400/10 transition touch-target';

            wrapper.addEventListener('click', () => selectChoice(key));

            if (hasImage) {
                const badge = document.createElement('div');
                badge.className = 'absolute top-2 left-2 z-10 px-2 py-1 rounded-full bg-slate-900/80 text-orange-200 text-xs font-semibold border border-orange-300/40';
                badge.textContent = key;
                wrapper.appendChild(badge);

                const imgBox = document.createElement('div');
                imgBox.className = 'bg-white rounded-lg p-2 border border-gray-200';
                const img = document.createElement('img');
                img.className = 'w-full h-auto rounded';
                img.alt = `選択肢 ${key}`;
                const cands = getImageCandidates(value);
                setImageWithFallback(img, cands, () => {
                    imgBox.innerHTML = '';
                    imgBox.classList.add('hidden');
                });
                imgBox.appendChild(img);
                wrapper.appendChild(imgBox);
            } else {
                const row = document.createElement('div');
                row.className = 'flex items-start gap-3';
                const radio = document.createElement('div');
                radio.className = 'mt-0.5 w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center choice-radio';
                radio.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-orange-400 hidden choice-dot"></div>';
                const textBox = document.createElement('div');
                textBox.className = 'flex-1 text-sm text-gray-100 leading-relaxed';
                textBox.innerHTML = `<span class="font-semibold text-orange-300 mr-2">${key}</span>${value}`;
                row.appendChild(radio);
                row.appendChild(textBox);
                wrapper.appendChild(row);
            }

            container.appendChild(wrapper);
        });

        markSelected(question);
    }

    function markSelected(question) {
        const selected = answers[currentIndex]?.choice;
        document.querySelectorAll('#choices-container button').forEach(btn => {
            const isSelected = btn.dataset.choice === selected;
            btn.classList.toggle('border-orange-400', isSelected);
            btn.classList.toggle('bg-orange-500/10', isSelected);
            const dot = btn.querySelector('.choice-dot');
            if (dot) {
                dot.classList.toggle('hidden', !isSelected);
            }
        });
    }

    function renderQuestion(index) {
        const q = questions[index];
        if (!q) return;

        document.getElementById('current-number').textContent = index + 1;
        document.getElementById('question-label').textContent = `設問 ${index + 1}`;
        document.getElementById('question-text').textContent = q.question_text || '';
        document.getElementById('question-genre').textContent = q.genre || 'ジャンル未設定';
        document.getElementById('question-id').textContent = q.question_id || q.id || 'ID不明';

        const imgBox = document.getElementById('question-image');
        imgBox.innerHTML = '';
        const resolvedImage = getImageCandidates(q.image_url);
        if (resolvedImage.length) {
            const img = document.createElement('img');
            img.className = 'max-w-full h-auto rounded-lg border border-white/10 bg-white/5 p-2';
            img.alt = '問題画像';
            setImageWithFallback(img, resolvedImage, () => {
                imgBox.innerHTML = '';
                imgBox.classList.add('hidden');
            });
            imgBox.appendChild(img);
            imgBox.classList.remove('hidden');
        } else {
            imgBox.classList.add('hidden');
        }

        renderChoices(q);
        updateNavButtons();
        updateProgressBar();
    }

    function updateProgressBar() {
        const percent = ((currentIndex + 1) / questions.length) * 100;
        document.getElementById('progress-bar').style.width = `${percent}%`;
    }

    function updateNavButtons() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        prevBtn.disabled = currentIndex === 0;
        const nextText = document.getElementById('next-btn-text');
        if (currentIndex === questions.length - 1) {
            nextText.textContent = '採点する';
        } else {
            nextText.textContent = '次へ';
        }
    }

    function selectChoice(choice) {
        answers[currentIndex] = { choice };
        markSelected(questions[currentIndex]);
    }

    function goNext() {
        if (currentIndex === questions.length - 1) {
            submitExam();
            return;
        }
        currentIndex = Math.min(currentIndex + 1, questions.length - 1);
        renderQuestion(currentIndex);
    }

    function goPrev() {
        currentIndex = Math.max(currentIndex - 1, 0);
        renderQuestion(currentIndex);
    }

    function submitExam() {
        const nextBtn = document.getElementById('next-btn');
        nextBtn.disabled = true;
        nextBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>採点中...</span>';

        const payload = {
            exam_session_id: examSessionId,
            answers: Object.fromEntries(Object.entries(answers).map(([k, v]) => [String(k), v.choice]))
        };

        fetch('{{ url_for('exam.submit_mock_exam') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                showResult(data);
            })
            .catch(err => {
                alert('採点中にエラーが発生しました: ' + err.message);
                nextBtn.disabled = false;
                updateNavButtons();
            });
    }

    function showResult(data) {
        document.getElementById('result-card').classList.remove('hidden');
        document.getElementById('result-score').textContent = `${data.score}%`;
        document.getElementById('result-correct').textContent = `正解 ${data.correct_count} 問`;
        document.getElementById('result-total').textContent = `合計 ${data.total_count} 問`;

        // 詳細リストを描画
        const detailsWrap = document.getElementById('result-details');
        detailsWrap.innerHTML = '';
        (data.details || []).forEach(item => {
            const card = document.createElement('div');
            card.className = 'rounded-xl border border-white/10 bg-white/5 p-4';

            const header = document.createElement('div');
            header.className = 'flex items-center justify-between gap-2 mb-2 flex-wrap';
            const title = document.createElement('div');
            title.className = 'text-sm text-gray-200';
            title.textContent = `Q${item.index}: ${item.question_id || 'ID不明'}`;
            const badge = document.createElement('span');
            badge.className = item.is_correct
                ? 'px-2.5 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/50 text-emerald-200 text-xs'
                : 'px-2.5 py-1 rounded-full bg-red-500/20 border border-red-400/50 text-red-200 text-xs';
            badge.textContent = item.is_correct ? '正解' : '不正解';
            header.appendChild(title);
            header.appendChild(badge);
            card.appendChild(header);

            const qText = document.createElement('p');
            qText.className = 'text-gray-100 text-sm whitespace-pre-line mb-2';
            qText.textContent = item.question_text || '';
            card.appendChild(qText);

            if (item.image_url) {
                const img = document.createElement('img');
                img.className = 'max-w-full h-auto rounded-lg border border-white/10 bg-white/5 p-2 mb-2';
                const cands = getImageCandidates(item.image_url);
                setImageWithFallback(img, cands, () => { img.remove(); });
                img.alt = '問題画像';
                card.appendChild(img);
            }

            const ansRow = document.createElement('div');
            ansRow.className = 'flex flex-wrap gap-2 text-sm text-gray-200 mb-2';
            ansRow.innerHTML = `あなたの回答: <span class="font-semibold ${item.is_correct ? 'text-emerald-300' : 'text-red-300'}">${item.user_answer || '未回答'}</span> / 正解: <span class="font-semibold text-orange-200">${item.correct_answer || '-'} </span>`;
            card.appendChild(ansRow);

            if (item.explanation) {
                const exp = document.createElement('div');
                exp.className = 'text-sm text-gray-200 bg-amber-500/10 border border-amber-400/30 rounded-lg p-3 whitespace-pre-line';
                exp.textContent = item.explanation;
                card.appendChild(exp);
            }

            detailsWrap.appendChild(card);
        });

        // lock navigation & update button表示
        const nextBtn = document.getElementById('next-btn');
        nextBtn.disabled = true;
        nextBtn.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    <span>採点完了</span>`;
        document.getElementById('prev-btn').disabled = true;
    }

    // Event wiring
    document.getElementById('next-btn').addEventListener('click', goNext);
    document.getElementById('prev-btn').addEventListener('click', goPrev);

    // Initial render
    renderQuestion(currentIndex);
</script>
{% endblock %}