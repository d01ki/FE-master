{% extends "base.html" %}

{% block title %}å•é¡Œ - {{ super() }}{% endblock %}

{% block content %}
<div class="h-screen overflow-auto pb-0">
    <div class="max-w-3xl mx-auto px-4 py-4">
        <!-- Question Card -->
        <div class="bg-white/5 backdrop-blur-md rounded-xl shadow-lg border border-white/10 overflow-hidden">
            <!-- Header -->
            <div class="px-4 py-3 bg-white/5 border-b border-white/10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h1 class="text-base font-semibold text-white">åŸºæœ¬æƒ…å ±æŠ€è¡“è€…è©¦é¨“</h1>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        {% if question.genre %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30">
                                {{ question.genre }}
                            </span>
                        {% endif %}
                        <span class="text-xs text-gray-400 bg-white/5 px-2 py-1 rounded-full">
                            No.{{ question.question_id or question.id }}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="p-4">
                <!-- Question Text -->
                <div class="mb-4">
                    <p class="text-gray-200 text-base leading-relaxed whitespace-pre-line">{{ question.question_text }}</p>
                </div>
                
                <!-- Question Image -->
                {% if question.image_url %}
                <div class="mb-4">
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                        {% if question.image_url.startswith('http') %}
                            <img src="{{ question.image_url }}" 
                                 alt="å•é¡Œã®å›³è¡¨" 
                                 class="max-w-full h-auto rounded-lg mx-auto shadow-sm"
                                 onerror="this.parentElement.innerHTML='<p class=\'text-gray-400 text-center py-3 text-sm\'>ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>'">
                        {% else %}
                            {% set img_filename = question.image_url.split('/')[-1] %}
                            <img src="{{ url_for('images.serve_question_image', filename=img_filename) }}" 
                                 alt="å•é¡Œã®å›³è¡¨" 
                                 class="max-w-full h-auto rounded-lg mx-auto shadow-sm"
                                 onerror="this.parentElement.innerHTML='<p class=\'text-red-400 text-center py-3 text-sm\'>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {{ img_filename | e }}<br><span class=\'text-xs text-gray-500\'>ç®¡ç†è€…ã«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ä¾é ¼ã—ã¦ãã ã•ã„</span></p>'">
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Choices -->
                {% if question.has_image_choices %}
                    <!-- Image Choices: Grid Layout -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        {% for choice_key, choice_value in question.choices.items() %}
                            <button class="choice-option choice-image-option relative p-2 bg-white/5 rounded-lg border-2 border-white/10 hover:border-blue-400/50 hover:bg-blue-500/10 transition-all duration-200 group"
                                    data-choice="{{ choice_key }}"
                                    onclick="selectAnswer('{{ choice_key }}')">
                                <div class="absolute top-2 left-2 z-10">
                                    <div class="flex items-center">
                                        <div class="w-5 h-5 rounded-full border-2 border-gray-400 bg-slate-900 flex items-center justify-center choice-radio group-hover:border-blue-400 transition-colors">
                                            <div class="w-2.5 h-2.5 rounded-full bg-blue-500 hidden choice-dot"></div>
                                        </div>
                                        <span class="font-semibold text-gray-300 text-sm ml-1.5 bg-slate-900/90 px-1.5 py-0.5 rounded">{{ choice_key }}</span>
                                    </div>
                                </div>
                                
                                <div class="bg-white rounded-lg p-2 border border-gray-200">
                                    {% if choice_value.startswith('http') %}
                                        <img src="{{ choice_value }}" 
                                             alt="é¸æŠè‚¢ {{ choice_key }}" 
                                             class="w-full h-auto rounded"
                                             onerror="this.parentElement.innerHTML='<p class=\\'text-gray-400 text-center py-4 text-xs\\'>{{ choice_key }}. ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>'">
                                    {% else %}
                                        {% set img_filename = choice_value.split('/')[-1] %}
                                        <img src="{{ url_for('images.serve_question_image', filename=img_filename) }}" 
                                             alt="é¸æŠè‚¢ {{ choice_key }}" 
                                             class="w-full h-auto rounded"
                                             onerror="this.parentElement.innerHTML='<p class=\\'text-gray-400 text-center py-4 text-xs\\'>{{ choice_key }}. ç”»åƒ: {{ img_filename | e }}</p>'">
                                    {% endif %}
                                </div>
                            </button>
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- Text Choices: List Layout -->
                    <div class="space-y-2 mb-4">
                        {% for choice_key, choice_text in question.choices.items() %}
                            <button class="choice-option w-full text-left p-3 bg-white/5 rounded-lg border-2 border-white/10 hover:border-blue-400/50 hover:bg-blue-500/10 transition-all duration-200 group"
                                    data-choice="{{ choice_key }}"
                                    onclick="selectAnswer('{{ choice_key }}')">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 mt-0.5">
                                        <div class="w-5 h-5 rounded-full border-2 border-gray-400 bg-slate-900 flex items-center justify-center choice-radio group-hover:border-blue-400 transition-colors">
                                            <div class="w-2.5 h-2.5 rounded-full bg-blue-500 hidden choice-dot"></div>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <span class="font-semibold text-blue-400 text-sm mr-2">{{ choice_key }}</span>
                                        <span class="text-gray-200 text-sm leading-relaxed">{{ choice_text }}</span>
                                    </div>
                                </div>
                            </button>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Result Display Area (Initially Hidden) -->
                <div id="result-display" class="hidden">
                    <!-- Simple Feedback -->
                    <div id="answer-feedback" class="p-4 rounded-lg border-l-4 mb-4">
                        <h3 id="feedback-title" class="text-xl font-bold"></h3>
                    </div>
                    
                    <!-- Explanation -->
                    <div id="explanation-section" class="hidden">
                        <div class="bg-gradient-to-r from-amber-500/10 to-orange-500/10 border-l-4 border-amber-500 rounded-lg p-5 shadow-lg">
                            <div class="flex items-start mb-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-xl font-bold text-amber-400 mb-2">ğŸ’¡ è§£èª¬</h4>
                                    <p class="text-gray-400 text-xs">ã“ã®å•é¡Œã®è©³ã—ã„èª¬æ˜</p>
                                </div>
                            </div>
                            <div class="bg-slate-900/50 rounded-lg p-4 border border-amber-500/20">
                                <p id="explanation-text" class="text-gray-200 text-base leading-relaxed whitespace-pre-line"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="mt-4 mb-0 flex items-center justify-between">
            <button onclick="goHome()" 
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-300 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                ãƒ›ãƒ¼ãƒ 
            </button>
            
            <button id="next-button" onclick="nextQuestion()" disabled
                    class="inline-flex items-center px-6 py-2 text-base font-medium text-white bg-gray-600 border border-transparent rounded-lg cursor-not-allowed transition-all duration-200">
                <span id="next-button-text">è§£ç­”ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let answered = false;
let isCorrect = false;

function selectAnswer(selectedChoice) {
    if (answered) return;
    
    answered = true;
    
    // Add loading state to selected option
    const selectedOption = document.querySelector(`[data-choice="${selectedChoice}"]`);
    selectedOption.innerHTML += '<div class="absolute inset-0 bg-blue-100 rounded-lg flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div></div>';
    
    // Disable all choices
    document.querySelectorAll('.choice-option').forEach(option => {
        option.disabled = true;
        option.classList.remove('hover:border-blue-300', 'hover:bg-blue-50');
        option.classList.add('cursor-not-allowed', 'opacity-75');
    });
    
    // Submit answer
    fetch('/questions/{{ question.id }}/answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: '{{ question.id }}',
            answer: selectedChoice
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading state
        const loadingDiv = selectedOption.querySelector('.absolute.inset-0');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        
        showResult(data);
    })
    .catch(error => {
        console.error('Error:', error);
        // Remove loading state
        const loadingDiv = selectedOption.querySelector('.absolute.inset-0');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        showError();
    });
}

function showResult(data) {
    isCorrect = data.is_correct;
    
    // Update choice styling
    document.querySelectorAll('.choice-option').forEach((option, index) => {
        const choiceKey = option.getAttribute('data-choice');
        option.classList.remove('opacity-75');
        
        setTimeout(() => {
            if (choiceKey === data.correct_answer) {
                option.classList.add('border-green-500/70', 'bg-green-500/20');
                option.querySelector('.choice-radio').innerHTML = '<svg class="w-3.5 h-3.5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            } else if (choiceKey === data.user_answer && !isCorrect) {
                option.classList.add('border-red-500/70', 'bg-red-500/20');
                option.querySelector('.choice-radio').innerHTML = '<svg class="w-3.5 h-3.5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
            }
        }, index * 50);
    });
    
    // Show simple result
    setTimeout(() => {
        const feedbackElement = document.getElementById('answer-feedback');
        const titleElement = document.getElementById('feedback-title');
        
        if (isCorrect) {
            feedbackElement.className = 'p-4 rounded-lg border-l-4 mb-4 border-green-500 bg-green-500/20';
            titleElement.textContent = 'æ­£è§£ã§ã™ï¼';
            titleElement.className = 'text-xl font-bold text-green-400';
        } else {
            feedbackElement.className = 'p-4 rounded-lg border-l-4 mb-4 border-red-500 bg-red-500/20';
            titleElement.textContent = `ä¸æ­£è§£ï¼ˆæ­£è§£: ${data.correct_answer}ï¼‰`;
            titleElement.className = 'text-xl font-bold text-red-400';
        }
        
        // Show explanation
        if (data.explanation && data.explanation.trim()) {
            document.getElementById('explanation-text').textContent = data.explanation;
            const explanationSection = document.getElementById('explanation-section');
            explanationSection.classList.remove('hidden');
            
            // è§£èª¬ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                explanationSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 400);
        }
        
        document.getElementById('result-display').classList.remove('hidden');
        
        // Enable next button
        const nextButton = document.getElementById('next-button');
        nextButton.disabled = false;
        nextButton.className = 'inline-flex items-center px-6 py-2 text-base font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-lg cursor-pointer transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500';
        document.getElementById('next-button-text').textContent = 'æ¬¡ã®å•é¡Œã¸';
        
    }, 300);
}

function showError() {
    const feedbackElement = document.getElementById('answer-feedback');
    feedbackElement.className = 'p-5 rounded-lg border-l-4 mb-5 border-yellow-500 bg-yellow-500/20';
    document.getElementById('feedback-icon').innerHTML = '<svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
    document.getElementById('feedback-title').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    document.getElementById('feedback-title').className = 'text-lg font-semibold text-yellow-400';
    document.getElementById('feedback-message').textContent = 'è§£ç­”ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    document.getElementById('feedback-message').className = 'text-sm text-yellow-300 mt-1';
    document.getElementById('result-display').classList.remove('hidden');
}

function nextQuestion() {
    if (!answered) return;
    
    // Add loading animation to button
    const button = document.getElementById('next-button');
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-2">èª­ã¿è¾¼ã¿ä¸­...</span>';
    button.disabled = true;
    
    setTimeout(() => {
        {% if mode == 'random' %}
            window.location.href = "{{ url_for('practice.random_practice') }}";
        {% else %}
            window.location.href = "{{ url_for('practice.genre_practice') }}";
        {% endif %}
    }, 300);
}

function goHome() {
    window.location.href = "{{ url_for('main.dashboard') }}";
}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Escape key to go home
    if (e.key === 'Escape') {
        goHome();
        return;
    }
    
    if (answered) {
        // Space or Enter to proceed to next question
        if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            nextQuestion();
        }
        return;
    }
    
    // Number keys for choice selection (1-4)
    if (e.key >= '1' && e.key <= '4') {
        e.preventDefault();
        const choices = ['ã‚¢', 'ã‚¤', 'ã‚¦', 'ã‚¨'];
        const choiceIndex = parseInt(e.key) - 1;
        if (choiceIndex < choices.length) {
            const targetChoice = choices[choiceIndex];
            const targetButton = document.querySelector(`[data-choice="${targetChoice}"]`);
            if (targetButton && !answered) {
                // Add visual feedback for keyboard selection
                targetButton.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
                setTimeout(() => {
                    selectAnswer(targetChoice);
                }, 200);
            }
        }
    }
    
    // Letter keys for choice selection (a-d)
    const letterMap = { 'a': 'ã‚¢', 'i': 'ã‚¤', 'u': 'ã‚¦', 'e': 'ã‚¨' };
    if (letterMap[e.key.toLowerCase()]) {
        e.preventDefault();
        const targetChoice = letterMap[e.key.toLowerCase()];
        const targetButton = document.querySelector(`[data-choice="${targetChoice}"]`);
        if (targetButton && !answered) {
            targetButton.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
            setTimeout(() => {
                selectAnswer(targetChoice);
            }, 200);
        }
    }
});

// Show keyboard shortcuts hint
document.addEventListener('DOMContentLoaded', function() {
    if (!window.localStorage.getItem('keyboard-hint-shown')) {
        setTimeout(() => {
            const hint = document.createElement('div');
            hint.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50 animate-pulse';
            hint.innerHTML = 'ãƒ’ãƒ³ãƒˆ: 1-4ã‚­ãƒ¼ã§é¸æŠè‚¢ã‚’é¸ã¹ã¾ã™';
            document.body.appendChild(hint);
            
            setTimeout(() => {
                hint.style.opacity = '0';
                setTimeout(() => hint.remove(), 300);
            }, 3000);
            
            window.localStorage.setItem('keyboard-hint-shown', 'true');
        }, 1000);
    }
});
</script>
{% endblock %}
