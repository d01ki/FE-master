{% extends "base.html" %}

{% block title %}ÂïèÈ°å - {{ super() }}{% endblock %}

{% block content %}
<div class="h-screen overflow-auto pb-0">
    <div class="max-w-3xl mx-auto px-4 py-4">
        <!-- Question Card -->
        <div class="glass-card rounded-xl shadow-2xl border border-white/10 overflow-hidden" style="max-width: 100%;">
            <!-- Header -->
            <div class="px-4 py-3 bg-white/5 border-b border-white/10">
                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-white shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-400">Âü∫Êú¨ÊÉÖÂ†±ÊäÄË°ìËÄÖË©¶È®ì</p>
                            <h1 class="text-lg font-semibold text-white">ÊºîÁøíÂïèÈ°å</h1>
                        </div>
                    </div>
                    
                    <div class="flex items-center flex-wrap gap-2">
                        {% if question.genre %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-500/15 text-blue-200 border border-blue-500/30">
                                {{ question.genre }}
                            </span>
                        {% endif %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-white/10 text-gray-200 border border-white/10">
                            No.{{ question.question_id or question.id }}
                        </span>
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-500/15 text-emerald-200 border border-emerald-500/30">
                            {{ '„É©„É≥„ÉÄ„É†' if mode == 'random' else 'ÂàÜÈáéÂà•' }} „É¢„Éº„Éâ
                        </span>
                    </div>
                </div>
                <div class="mt-3 h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-blue-400 via-cyan-300 to-emerald-300 animate-pulse" style="width: 60%"></div>
                </div>
            </div>
            
            <div class="p-4">
                <!-- Question Text -->
                <div class="mb-4">
                    <p class="text-gray-200 text-base leading-relaxed whitespace-pre-line">{{ question.question_text }}</p>
                </div>
                
                <!-- Question Image -->
                {% if question.image_url %}
                <div class="mb-4">
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10" id="question-image-wrapper">
                        <img id="question-image" data-src="{{ question.image_url }}" 
                             alt="ÂïèÈ°å„ÅÆÂõ≥Ë°®" 
                             class="max-w-full h-auto rounded-lg mx-auto shadow-sm hidden">
                    </div>
                </div>
                {% endif %}
                
                <!-- Choices -->
                {% if question.has_image_choices %}
                    <!-- Image Choices: Grid Layout -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        {% for choice_key, choice_value in question.choices.items() %}
                            <button class="choice-option choice-image-option relative p-2 bg-white/5 rounded-lg border-2 border-white/10 hover:border-blue-400/50 hover:bg-blue-500/10 transition-all duration-200 group"
                                    data-choice="{{ choice_key }}"
                                    onclick="selectAnswer('{{ choice_key }}')">
                                <div class="absolute top-2 left-2 z-10">
                                    <div class="flex items-center">
                                        <div class="w-5 h-5 rounded-full border-2 border-gray-400 bg-slate-900 flex items-center justify-center choice-radio group-hover:border-blue-400 transition-colors">
                                            <div class="w-2.5 h-2.5 rounded-full bg-blue-500 hidden choice-dot"></div>
                                        </div>
                                        <span class="font-semibold text-gray-300 text-sm ml-1.5 bg-slate-900/90 px-1.5 py-0.5 rounded">{{ choice_key }}</span>
                                    </div>
                                </div>
                                
                                <div class="bg-white rounded-lg p-2 border border-gray-200 choice-image-box">
                                    <img data-choice-img="true"
                                         data-src="{{ choice_value }}"
                                         alt="ÈÅ∏ÊäûËÇ¢ {{ choice_key }}" 
                                         class="w-full h-auto rounded hidden">
                                </div>
                            </button>
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- Text Choices: List Layout -->
                    <div class="space-y-2 mb-4">
                        {% for choice_key, choice_text in question.choices.items() %}
                            <button class="choice-option w-full text-left p-3 sm:p-4 bg-white/5 rounded-xl border-2 border-white/10 hover:border-blue-400/60 hover:bg-blue-500/10 transition-all duration-200 group focus:outline-none focus:ring-2 focus:ring-blue-400/70 focus:ring-offset-0"
                                    role="radio"
                                    aria-checked="false"
                                    data-choice="{{ choice_key }}"
                                    onclick="selectAnswer('{{ choice_key }}')">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 mt-0.5">
                                        <div class="w-5 h-5 rounded-full border-2 border-gray-400 bg-slate-900 flex items-center justify-center choice-radio group-hover:border-blue-400 transition-colors">
                                            <div class="w-2.5 h-2.5 rounded-full bg-blue-500 hidden choice-dot"></div>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <span class="font-semibold text-blue-400 text-sm mr-2">{{ choice_key }}</span>
                                        <span class="text-gray-100 text-sm leading-relaxed">{{ choice_text }}</span>
                                    </div>
                                </div>
                            </button>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Result Display Area (Initially Hidden) -->
                <div id="result-display" class="hidden">
                    <!-- Simple Feedback -->
                    <div id="answer-feedback" class="p-4 rounded-lg border-l-4 mb-4">
                        <h3 id="feedback-title" class="text-xl font-bold"></h3>
                    </div>
                    
                    <!-- Explanation -->
                    <div id="explanation-section" class="hidden">
                        <div class="bg-gradient-to-r from-amber-500/10 to-orange-500/10 border-l-4 border-amber-500 rounded-lg p-5 shadow-lg">
                            <div class="flex items-start mb-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-xl font-bold text-amber-400 mb-2">üí° Ëß£Ë™¨</h4>
                                    <p class="text-gray-400 text-xs">„Åì„ÅÆÂïèÈ°å„ÅÆË©≥„Åó„ÅÑË™¨Êòé</p>
                                </div>
                            </div>
                            <div class="bg-slate-900/50 rounded-lg p-4 border border-amber-500/20">
                                <p id="explanation-text" class="text-gray-200 text-base leading-relaxed whitespace-pre-line"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="mt-4 mb-0 flex items-center justify-between">
            <button onclick="goHome()" 
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-300 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                „Éõ„Éº„É†
            </button>
            
                    <button id="next-button" onclick="nextQuestion()" disabled
                        class="inline-flex items-center px-6 py-3 text-base font-semibold text-white bg-gradient-to-r from-slate-600 to-slate-500 border border-transparent rounded-xl cursor-not-allowed transition-all duration-200 shadow-lg touch-target">
                <span id="next-button-text">Ëß£Á≠î„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let answered = false;
let isCorrect = false;
const genreName = "{{ genre|default('') }}";
const serveBase = "{{ url_for('images.serve_question_image', filename='__FILENAME__') }}";

function getImageCandidates(val) {
    if (!val) return [];
    const v = String(val).trim();
    if (!v) return [];

    const uniq = new Set();
    const add = (url) => { if (url) uniq.add(url); };
    const fname = v.split(/[\\/]/).pop();

    if (v.startsWith('http://') || v.startsWith('https://')) add(v);
    if (v.startsWith('/images/questions/')) add(v);
    if (v.startsWith('images/questions/')) add('/' + v);
    if (v.includes('protected_images/questions/')) add(serveBase.replace('__FILENAME__', fname));
    if (v.startsWith('/static/')) add(v);
    if (v.startsWith('static/')) add('/' + v);

    add(serveBase.replace('__FILENAME__', fname));
    add('/static/images/questions/' + fname);

    return Array.from(uniq);
}

function setImageWithFallback(imgEl, candidates, onFail) {
    const list = [...candidates];
    if (!list.length) {
        onFail?.();
        return;
    }
    const tryNext = () => {
        if (!list.length) {
            onFail?.();
            return;
        }
        const url = list.shift();
        imgEl.src = url;
        imgEl.onerror = tryNext;
        imgEl.onload = () => {
            imgEl.classList.remove('hidden');
        };
    };
    tryNext();
}

document.addEventListener('DOMContentLoaded', () => {
    const qImg = document.getElementById('question-image');
    if (qImg) {
        const cands = getImageCandidates(qImg.dataset.src);
        const box = document.getElementById('question-image-wrapper');
        if (cands.length) {
            setImageWithFallback(qImg, cands, () => box?.classList.add('hidden'));
        } else {
            box?.classList.add('hidden');
        }
    }

    document.querySelectorAll('[data-choice-img]').forEach(img => {
        const cands = getImageCandidates(img.dataset.src);
        const box = img.closest('.choice-image-box') || img.parentElement;
        if (cands.length) {
            setImageWithFallback(img, cands, () => box?.classList.add('hidden'));
        } else {
            box?.classList.add('hidden');
        }
    });
});

function selectAnswer(selectedChoice) {
    if (answered) return;
    
    answered = true;
    
    // Add loading state to selected option
    const selectedOption = document.querySelector(`[data-choice="${selectedChoice}"]`);
    selectedOption.setAttribute('aria-checked', 'true');
    selectedOption.innerHTML += '<div class="absolute inset-0 bg-blue-100 rounded-lg flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div></div>';
    
    // Disable all choices
    document.querySelectorAll('.choice-option').forEach(option => {
        option.disabled = true;
        option.classList.remove('hover:border-blue-300', 'hover:bg-blue-50');
        option.classList.add('cursor-not-allowed', 'opacity-75');
        option.setAttribute('aria-checked', option.getAttribute('data-choice') === selectedChoice ? 'true' : 'false');
    });
    
    // Submit answer
    fetch('/questions/{{ question.id }}/answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: '{{ question.id }}',
            answer: selectedChoice
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading state
        const loadingDiv = selectedOption.querySelector('.absolute.inset-0');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        
        showResult(data);
    })
    .catch(error => {
        console.error('Error:', error);
        // Remove loading state
        const loadingDiv = selectedOption.querySelector('.absolute.inset-0');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        showError();
    });
}

function showResult(data) {
    isCorrect = data.is_correct;
    
    // Update choice styling
    document.querySelectorAll('.choice-option').forEach((option, index) => {
        const choiceKey = option.getAttribute('data-choice');
        option.classList.remove('opacity-75');
        
        setTimeout(() => {
            if (choiceKey === data.correct_answer) {
                option.classList.add('border-green-500/70', 'bg-green-500/20');
                option.querySelector('.choice-radio').innerHTML = '<svg class="w-3.5 h-3.5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            } else if (choiceKey === data.user_answer && !isCorrect) {
                option.classList.add('border-red-500/70', 'bg-red-500/20');
                option.querySelector('.choice-radio').innerHTML = '<svg class="w-3.5 h-3.5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
            }
        }, index * 50);
    });
    
    // Show simple result
    setTimeout(() => {
        const feedbackElement = document.getElementById('answer-feedback');
        const titleElement = document.getElementById('feedback-title');
        
        if (isCorrect) {
            feedbackElement.className = 'p-4 rounded-lg border-l-4 mb-4 border-green-500 bg-green-500/20';
            titleElement.textContent = 'Ê≠£Ëß£„Åß„ÅôÔºÅ';
            titleElement.className = 'text-xl font-bold text-green-400';
        } else {
            feedbackElement.className = 'p-4 rounded-lg border-l-4 mb-4 border-red-500 bg-red-500/20';
            titleElement.textContent = `‰∏çÊ≠£Ëß£ÔºàÊ≠£Ëß£: ${data.correct_answer}Ôºâ`;
            titleElement.className = 'text-xl font-bold text-red-400';
        }
        
        // Show explanation
        if (data.explanation && data.explanation.trim()) {
            document.getElementById('explanation-text').textContent = data.explanation;
            const explanationSection = document.getElementById('explanation-section');
            explanationSection.classList.remove('hidden');
            
            // Ëß£Ë™¨„Å´„Çπ„ÇØ„É≠„Éº„É´
            setTimeout(() => {
                explanationSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 400);
        }
        
        document.getElementById('result-display').classList.remove('hidden');
        
        // Enable next button
        const nextButton = document.getElementById('next-button');
        nextButton.disabled = false;
        nextButton.className = 'inline-flex items-center px-6 py-3 text-base font-semibold text-white bg-gradient-to-r from-blue-600 to-cyan-500 hover:brightness-105 border border-transparent rounded-xl cursor-pointer transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400 shadow-xl';
        document.getElementById('next-button-text').textContent = 'Ê¨°„ÅÆÂïèÈ°å„Å∏';
        
    }, 300);
}

function showError() {
    const feedbackElement = document.getElementById('answer-feedback');
    feedbackElement.className = 'p-5 rounded-lg border-l-4 mb-5 border-yellow-500 bg-yellow-500/20';
    document.getElementById('feedback-icon').innerHTML = '<svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
    document.getElementById('feedback-title').textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
    document.getElementById('feedback-title').className = 'text-lg font-semibold text-yellow-400';
    document.getElementById('feedback-message').textContent = 'Ëß£Á≠î„ÅÆÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
    document.getElementById('feedback-message').className = 'text-sm text-yellow-300 mt-1';
    document.getElementById('result-display').classList.remove('hidden');
}

function nextQuestion() {
    if (!answered) return;
    
    // Add loading animation to button
    const button = document.getElementById('next-button');
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-2">Ë™≠„ÅøËæº„Åø‰∏≠...</span>';
    button.disabled = true;
    
    setTimeout(() => {
        {% if mode == 'random' %}
            window.location.href = "{{ url_for('practice.random_practice') }}";
        {% else %}
            if (genreName) {
                window.location.href = "{{ url_for('practice.practice_by_genre', genre='__GENRE__') }}".replace('__GENRE__', encodeURIComponent(genreName));
            } else {
                window.location.href = "{{ url_for('practice.genre_practice') }}";
            }
        {% endif %}
    }, 300);
}

function goHome() {
    window.location.href = "{{ url_for('main.dashboard') }}";
}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Escape key to go home
    if (e.key === 'Escape') {
        goHome();
        return;
    }
    
    if (answered) {
        // Space or Enter to proceed to next question
        if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            nextQuestion();
        }
        return;
    }
    
    // Number keys for choice selection (1-4)
    if (e.key >= '1' && e.key <= '4') {
        e.preventDefault();
        const choices = ['„Ç¢', '„Ç§', '„Ç¶', '„Ç®'];
        const choiceIndex = parseInt(e.key) - 1;
        if (choiceIndex < choices.length) {
            const targetChoice = choices[choiceIndex];
            const targetButton = document.querySelector(`[data-choice="${targetChoice}"]`);
            if (targetButton && !answered) {
                // Add visual feedback for keyboard selection
                targetButton.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
                setTimeout(() => {
                    selectAnswer(targetChoice);
                }, 200);
            }
        }
    }
    
    // Letter keys for choice selection (a-d)
    const letterMap = { 'a': '„Ç¢', 'i': '„Ç§', 'u': '„Ç¶', 'e': '„Ç®' };
    if (letterMap[e.key.toLowerCase()]) {
        e.preventDefault();
        const targetChoice = letterMap[e.key.toLowerCase()];
        const targetButton = document.querySelector(`[data-choice="${targetChoice}"]`);
        if (targetButton && !answered) {
            targetButton.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
            setTimeout(() => {
                selectAnswer(targetChoice);
            }, 200);
        }
    }
});

// Show keyboard shortcuts hint
document.addEventListener('DOMContentLoaded', function() {
    if (!window.localStorage.getItem('keyboard-hint-shown')) {
        setTimeout(() => {
            const hint = document.createElement('div');
            hint.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50 animate-pulse';
            hint.innerHTML = '„Éí„É≥„Éà: 1-4„Ç≠„Éº„ÅßÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Åπ„Åæ„Åô';
            document.body.appendChild(hint);
            
            setTimeout(() => {
                hint.style.opacity = '0';
                setTimeout(() => hint.remove(), 300);
            }, 3000);
            
            window.localStorage.setItem('keyboard-hint-shown', 'true');
        }, 1000);
    }
});
</script>
{% endblock %}
